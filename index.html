<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrabble RO - Vercel Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        // Importam modulele necesare din Firebase SDK 12.9.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

        // ConfiguraÈ›ia ta Firebase furnizatÄƒ
        const firebaseConfig = {
            apiKey: "AIzaSyAlDknyr0Iq7o3AQfvbmdVGSfqbmXcpu84",
            authDomain: "scrabble-ro.firebaseapp.com",
            projectId: "scrabble-ro",
            storageBucket: "scrabble-ro.firebasestorage.app",
            messagingSenderId: "233579107851",
            appId: "1:233579107851:web:96913ea9bec49c8183990e",
            measurementId: "G-LHZ0KWETMV"
        };

        // Initializare Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // ID-ul aplicatiei definit in backend
        const appId = 'scrabble-ro';

        // State-ul local
        let sessionId = "";
        let playerId = localStorage.getItem('scrabble_player_id') || null;
        let gameState = null;
        let availableDictionaries = {};
        let isHost = false;

        // --- FUNCTII API CATRE VERCEL ---

        async function apiRequest(endpoint, method = 'POST', body = null) {
            try {
                const response = await fetch(`/api/${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : null
                });
                return await response.json();
            } catch (err) {
                console.error("Eroare API:", err);
                return { error: "Nu s-a putut contacta serverul." };
            }
        }

        // ÃncarcÄƒ dicÈ›ionarele disponibile
        async function loadDictionaries() {
            const data = await apiRequest('dictionaries', 'GET');
            if (data.dictionaries) {
                availableDictionaries = data.dictionaries;
                populateDictionarySelect();
            }
        }

        // PopuleazÄƒ select-ul cu dicÈ›ionare
        function populateDictionarySelect() {
            const select = document.getElementById('dictionary-select');
            select.innerHTML = '';
            for (const [key, dict] of Object.entries(availableDictionaries)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${dict.name} (${dict.description})`;
                select.appendChild(option);
            }
        }

        // FuncÈ›ii globale pentru butoanele din UI

        // AfiÈ™eazÄƒ/ascunde setÄƒrile
        window.toggleSettings = () => {
            const settingsPanel = document.getElementById('settings-panel');
            settingsPanel.classList.toggle('hidden');
        };

        // CreeazÄƒ joc cu setÄƒrile selectate
        window.createGame = async () => {
            const name = document.getElementById('player-name').value || 'JucÄƒtor 1';
            
            // ObÈ›ine setÄƒrile
            const settings = {
                max_players: parseInt(document.getElementById('max-players').value) || 4,
                rack_size: parseInt(document.getElementById('rack-size').value) || 7,
                bag_size: parseInt(document.getElementById('bag-size').value) || 100,
                dictionary: document.getElementById('dictionary-select').value || 'loc-flexiuni-5.0.txt'
            };
            
            const data = await apiRequest('session/create', 'POST', { 
                name, 
                player_id: playerId,
                ...settings
            });
            
            if (data.session_id) {
                sessionId = data.session_id;
                playerId = data.player_id;
                isHost = true;
                localStorage.setItem('scrabble_player_id', playerId);
                startListening(sessionId);
            } else if (data.error) {
                alert(data.error);
            }
        };

        window.joinGame = async () => {
            const name = document.getElementById('player-name').value || 'JucÄƒtor 2';
            const sId = document.getElementById('session-id-input').value.trim();
            if (!sId) return alert("Introdu codul sesiunii!");
            
            const data = await apiRequest('session/join', 'POST', { 
                session_id: sId, 
                name, 
                player_id: playerId 
            });
            
            if (data.error) return alert(data.error);
            
            sessionId = sId;
            playerId = data.player_id;
            localStorage.setItem('scrabble_player_id', playerId);
            startListening(sessionId);
        };

        // --- SINCRONIZARE REAL-TIME ---

        function startListening(sId) {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('display-session-id').textContent = sId;

            // Ascultam schimbarile din Firestore
            const sessionPath = `artifacts/${appId}/public/data/sessions/${sId}`;
            onSnapshot(doc(db, sessionPath), (docSnap) => {
                if (docSnap.exists()) {
                    gameState = docSnap.data();
                    renderGame();
                } else {
                    console.warn("Sesiunea nu mai exista.");
                }
            }, (error) => {
                console.error("Eroare Firestore:", error);
            });
        }

        function renderGame() {
            if (!gameState) return;
            
            // Convertim board-ul din map Ã®n matrice 15x15
            let boardMatrix = [];
            for (let i = 0; i < 15; i++) {
                let row = [];
                for (let j = 0; j < 15; j++) {
                    row.push(gameState.board[`${i}_${j}`] || null);
                }
                boardMatrix.push(row);
            }
            
            // AfiÈ™eazÄƒ setÄƒrile curente ale jocului
            const settings = gameState.game_settings || {};
            document.getElementById('current-settings').innerHTML = `
                <div class="text-xs text-slate-500 space-y-1">
                    <p>ğŸ“š DicÈ›ionar: ${availableDictionaries[settings.dictionary]?.name || settings.dictionary}</p>
                    <p>ğŸ‘¥ Max jucÄƒtori: ${settings.max_players}</p>
                    <p>ğŸ”¤ Litere Ã®n mÃ¢nÄƒ: ${settings.rack_size}</p>
                    <p>ğŸ“¦ Litere total: ${settings.bag_size}</p>
                </div>
            `;
            
            // Randare scoruri
            const playersEl = document.getElementById('players-list');
            playersEl.innerHTML = Object.values(gameState.players)
                .map(p => {
                    const isCurrentTurn = p.id === gameState.turn_order[gameState.current_turn_index];
                    const isHostBadge = p.is_host ? ' <span class="text-xs bg-yellow-200 px-1 rounded">HOST</span>' : '';
                    return `<div class="p-2 border rounded ${isCurrentTurn ? 'bg-blue-100 border-blue-500 font-bold' : 'bg-white'}">
                        ${p.name}${isHostBadge}: ${p.score} pct
                    </div>`;
                }).join('');

            // Randare tabla
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            boardMatrix.forEach((row, rIdx) => {
                row.forEach((cell, cIdx) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = "w-full h-full border border-gray-400 flex items-center justify-center bg-white text-xs sm:text-sm font-bold aspect-square cursor-pointer hover:bg-gray-100";
                    cellDiv.textContent = cell || '';
                    if (cell) cellDiv.classList.add('bg-yellow-100');
                    // AdaugÄƒ coordonatele ca data attributes
                    cellDiv.dataset.row = rIdx;
                    cellDiv.dataset.col = cIdx;
                    boardEl.appendChild(cellDiv);
                });
            });
            
            // Randare rack playerului curent
            const currentPlayer = gameState.players[playerId];
            if (currentPlayer && currentPlayer.rack) {
                const rackEl = document.getElementById('player-rack');
                if (rackEl) {
                    rackEl.innerHTML = currentPlayer.rack.map(letter => 
                        `<div class="w-8 h-8 border-2 border-slate-400 rounded bg-white flex items-center justify-center font-bold text-lg cursor-pointer hover:bg-slate-100" data-letter="${letter}">${letter}</div>`
                    ).join('');
                }
            }
        }

        // ÃncarcÄƒ dicÈ›ionarele la pornire
        loadDictionaries();
    </script>
    <style>
        #board { 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 sm:p-8 font-sans">

    <!-- LOBBY -->
    <div id="lobby" class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-extrabold text-slate-800 mb-6 text-center">Scrabble RO</h1>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Numele tÄƒu</label>
                <input id="player-name" type="text" placeholder="Ex: Andrei" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            
            <!-- Buton SetÄƒri -->
            <button onclick="toggleSettings()" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 rounded-lg transition text-sm">
                âš™ï¸ SetÄƒri Joc
            </button>
            
            <!-- Panoul SetÄƒri (ascuns implicit) -->
            <div id="settings-panel" class="hidden bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
                <h3 class="font-bold text-slate-700 text-sm">Configurare Joc</h3>
                
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">NumÄƒr maxim jucÄƒtori</label>
                    <input id="max-players" type="number" min="2" max="10" value="4" class="w-full p-2 border border-slate-300 rounded text-sm">
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">Litere Ã®n mÃ¢nÄƒ</label>
                    <input id="rack-size" type="number" min="5" max="15" value="7" class="w-full p-2 border border-slate-300 rounded text-sm">
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">Total litere Ã®n pungÄƒ</label>
                    <input id="bag-size" type="number" min="50" max="200" value="100" class="w-full p-2 border border-slate-300 rounded text-sm">
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">DicÈ›ionar</label>
                    <select id="dictionary-select" class="w-full p-2 border border-slate-300 rounded text-sm">
                        <option value="loc-flexiuni-5.0.txt">LOC Flexiuni 5.0 (~679k cuvinte)</option>
                        <option value="loc-flexiuni-6.0.txt">LOC Flexiuni 6.0 (~706k cuvinte)</option>
                    </select>
                </div>
            </div>
            
            <button onclick="createGame()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg">CreeazÄƒ Joc Nou</button>
            
            <div class="relative py-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <div class="relative flex justify-center text-sm"><span class="bg-white px-2 text-slate-500">SAU</span></div>
            </div>

            <div class="flex gap-2">
                <input id="session-id-input" type="text" placeholder="Cod Sesiune" class="flex-1 p-3 border border-slate-300 rounded-lg outline-none">
                <button onclick="joinGame()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-6 rounded-lg transition shadow-lg">AlÄƒturÄƒ-te</button>
            </div>
        </div>
    </div>

    <!-- GAME AREA -->
    <div id="game-area" class="hidden max-w-6xl mx-auto animate-fadeIn">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">CamerÄƒ: <span id="display-session-id" class="text-blue-600 tracking-widest"></span></h2>
                <div id="current-settings" class="mt-1"></div>
            </div>
            <div id="players-list" class="flex flex-wrap gap-2"></div>
        </header>
        
        <main class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div id="board" class="bg-slate-300 p-1 rounded shadow-2xl border-4 border-slate-800"></div>
            </div>
            
            <aside class="space-y-6">
                <!-- Rack-ul jucÄƒtorului -->
                <div class="bg-white p-5 rounded-2xl shadow-md border border-slate-200">
                    <h3 class="font-bold text-lg mb-3 text-slate-800 border-b pb-2">Literele Tale</h3>
                    <div id="player-rack" class="flex flex-wrap gap-1 justify-center"></div>
                </div>
                
                <div class="bg-white p-5 rounded-2xl shadow-md border border-slate-200">
                    <h3 class="font-bold text-lg mb-3 text-slate-800 border-b pb-2">AcÈ›iuni</h3>
                    <div id="controls" class="space-y-3">
                        <p class="text-sm text-slate-500 italic">SelecteazÄƒ literele din rack È™i apoi poziÈ›ioneazÄƒ-le pe tablÄƒ.</p>
                    </div>
                </div>
            </aside>
        </main>
    </div>

</body>
</html>
